<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="description" content="This function estimates mobility flows using different distribution models.
As described in (Lenormand et al. 2016)
, we
propose a two-step approach to generate mobility flows by separating the trip
distribution law, gravity or intervening opportunities, from the modeling
approach used to generate the flows from this law. This function only uses
the second step to generate mobility flow based on a matrix of probabilities
using different models."><title>Estimate mobility flows based on different trip distribution models — run_model • TDLM</title><!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png"><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png"><link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png"><link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png"><link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png"><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Estimate mobility flows based on different trip distribution models — run_model"><meta property="og:description" content="This function estimates mobility flows using different distribution models.
As described in (Lenormand et al. 2016)
, we
propose a two-step approach to generate mobility flows by separating the trip
distribution law, gravity or intervening opportunities, from the modeling
approach used to generate the flows from this law. This function only uses
the second step to generate mobility flow based on a matrix of probabilities
using different models."><meta property="og:image" content="https://epivec.github.io/TDLM/logo.png"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">TDLM</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item">
  <a class="nav-link" href="../articles/TDLM.html">Get started</a>
</li>
<li class="active nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul><form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off"></form>

      <ul class="navbar-nav"><li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/EpiVec/TDLM/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div>

    
  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Estimate mobility flows based on different trip distribution models</h1>
      <small class="dont-index">Source: <a href="https://github.com/EpiVec/TDLM/blob/HEAD/R/run_model.R" class="external-link"><code>R/run_model.R</code></a></small>
      <div class="d-none name"><code>run_model.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>This function estimates mobility flows using different distribution models.
As described in (Lenormand et al. 2016)
, we
propose a two-step approach to generate mobility flows by separating the trip
distribution law, gravity or intervening opportunities, from the modeling
approach used to generate the flows from this law. This function only uses
the second step to generate mobility flow based on a matrix of probabilities
using different models.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">run_model</span><span class="op">(</span></span>
<span>  <span class="va">proba</span>,</span>
<span>  model <span class="op">=</span> <span class="st">"UM"</span>,</span>
<span>  nb_trips <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  out_trips <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  in_trips <span class="op">=</span> <span class="va">out_trips</span>,</span>
<span>  average <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  nbrep <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  maxiter <span class="op">=</span> <span class="fl">50</span>,</span>
<span>  mindiff <span class="op">=</span> <span class="fl">0.01</span>,</span>
<span>  check_names <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>
    <dl><dt>proba</dt>
<dd><p>a squared matrix of probability. The sum of the matrix element
must be equal to 1. It will be normalized automatically if it is not the
case.</p></dd>


<dt>model</dt>
<dd><p>a character indicating which model to use.</p></dd>


<dt>nb_trips</dt>
<dd><p>a numeric value indicating the total number of trips. Must
be an integer if <code>average = FALSE</code> (see Details).</p></dd>


<dt>out_trips</dt>
<dd><p>a numeric vector representing the number of outgoing
trips per location. Must be a vector of integers
if <code>average = FALSE</code> (see Details).</p></dd>


<dt>in_trips</dt>
<dd><p>a numeric vector representing the number of incoming
trips per location. Must be a vector of integers
if <code>average = FALSE</code> (see Details).</p></dd>


<dt>average</dt>
<dd><p>a boolean indicating if the average mobility flow matrix
should be generated instead of the <code>nbrep</code> matrices based on
random draws (see Details).</p></dd>


<dt>nbrep</dt>
<dd><p>an integer indicating the number of replications
associated to the model run. Note that <code>nbrep = 1</code> if <code>average = TRUE</code>
(see Details).</p></dd>


<dt>maxiter</dt>
<dd><p>an integer indicating the maximal number of iterations for
adjusting the Doubly Constrained Model (see Details).</p></dd>


<dt>mindiff</dt>
<dd><p>a numeric strictly positive value indicating the
stopping criterion for adjusting the Doubly Constrained Model (see Details).</p></dd>


<dt>check_names</dt>
<dd><p>a boolean indicating if the ID location are used as
vector names, matrix rownames and colnames and if they should be checked
(see Note).</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    

<p>An object of class <code>TDLM</code>. A list of matrices containing the
<code>nbrep</code> simulated matrices.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p><script id="MathJax-script" async src="../../mathjaxr/doc/mathjax/es5/tex-chtml-full.js"></script></p>
<p>We propose four constrained models to generate the flow from the matrix
of probabilities. These models respect different level of
constraints. These constraints can preserve the total number of trips
(argument <code>nb_trips</code>) OR the number of out-going trips
<em></em>\(O_{i}\) (argument <code>out_trips</code>) AND/OR the number of in-coming
<em></em>\(D_{j}\) (argument <code>in_trips</code>) according to the model. The sum of
out-going trips <em></em>\(\sum_{i} O_{i}\) should be equal to the
sum of in-coming trips <em></em>\(\sum_{j} D_{j}\).</p><ol><li><p>Unconstrained model (<code>model = "UM"</code>). Only <code>nb_trips</code> will be preserved
(arguments <code>out_trips</code> and <code>in_trips</code> will not be used).</p></li>
<li><p>Production constrained model (<code>model = "PCM"</code>). Only <code>out_trips</code> will be
preserved (arguments <code>nb_trips</code> and <code>in_trips</code> will not be used).</p></li>
<li><p>Attraction constrained model (<code>model = "ACM"</code>). Only <code>in_trips</code> will be
preserved (arguments <code>nb_trips</code> and <code>out_trips</code> will not be used).</p></li>
<li><p>Doubly constrained model (<code>model = "DCM"</code>). Both <code>out_trips</code> and
<code>in_trips</code> will be preserved (arguments <code>nb_trips</code>will not be used). The
doubly constrained model is based on an Iterative Proportional Fitting
process (Deming and Stephan 1940)
. The arguments <code>maxiter</code> (50 by
default) and <code>mindiff</code> (0.01 by default) can be used to tune the model.
<code>mindiff</code> is the minimal tolerated relative error between the
simulated and observed marginals. <code>maxiter</code>
ensures that the algorithm stops even if it has not converged toward the
<code>mindiff</code> wanted value.</p></li>
</ol><p>By default, when <code>average = FALSE</code>, <code>nbrep</code> matrices are generated from
<code>proba</code> with multinomial random draws that will take different forms
according to the model used. In this case, the models will deal with positive
integers as inputs and outputs. Nevertheless, it is also possible to generate
an average matrix based on a multinomial distribution (based on an infinite
number of drawings. In this case, the models' inputs can be either positive
integer or real numbers and the output (<code>nbrep = 1</code> in this case) will be a
matrix of positive real numbers.</p>
    </div>
    <div class="section level2">
    <h2 id="note">Note<a class="anchor" aria-label="anchor" href="#note"></a></h2>
    <p>All the inputs should be based on the same number of
locations sorted in the same order. It is recommended to use the location ID
as vector names, matrix rownames and matrix colnames and to set
<code>check_names = TRUE</code> to verify that everything is in order before running
this function (<code>check_names = FALSE</code> by default). Note that the function
<code><a href="check_format_names.html">check_format_names()</a></code> can be used to control the validity of all the inputs
before running the main package's functions.</p>
    </div>
    <div class="section level2">
    <h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h2>
    <p>Lenormand M, Bassolas A, Ramasco JJ (2016).
“Systematic comparison of trip distribution laws and models.”
<em>Journal of Transport Geography</em>, <b>51</b>, 158-169.</p>
<p>Deming WE, Stephan FF (1940).
“On a Least Squares Adjustment of a Sample Frequency Table When the Expected Marginal Totals Are Known.”
<em>Annals of Mathematical Statistics</em>, <b>11</b>, 427-444.</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p><code><a href="gof.html">gof()</a></code> <code><a href="run_law_model.html">run_law_model()</a></code> <code><a href="run_law.html">run_law()</a></code> <code><a href="check_format_names.html">check_format_names()</a></code></p></div>
    </div>
    <div class="section level2">
    <h2 id="author">Author<a class="anchor" aria-label="anchor" href="#author"></a></h2>
    <p>Maxime Lenormand (<a href="mailto:maxime.lenormand@inrae.fr">maxime.lenormand@inrae.fr</a>)</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">mass</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">od</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">proba</span> <span class="op">&lt;-</span> <span class="va">od</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">od</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">Oi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">mass</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">Dj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">mass</span><span class="op">[</span>, <span class="fl">3</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu">run_model</span><span class="op">(</span></span></span>
<span class="r-in"><span>  proba <span class="op">=</span> <span class="va">proba</span>,</span></span>
<span class="r-in"><span>  model <span class="op">=</span> <span class="st">"DCM"</span>, nb_trips <span class="op">=</span> <span class="cn">NULL</span>, out_trips <span class="op">=</span> <span class="va">Oi</span>, in_trips <span class="op">=</span> <span class="va">Dj</span>,</span></span>
<span class="r-in"><span>  average <span class="op">=</span> <span class="cn">FALSE</span>, nbrep <span class="op">=</span> <span class="fl">3</span>, maxiter <span class="op">=</span> <span class="fl">50</span>, mindiff <span class="op">=</span> <span class="fl">0.01</span>,</span></span>
<span class="r-in"><span>  check_names <span class="op">=</span> <span class="cn">FALSE</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># print(res)</span></span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p></p><p>Developed by Maxime Lenormand.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer></div>

  

  

  </body></html>

