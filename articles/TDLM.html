<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Tutorial for TDLM • TDLM</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Tutorial for TDLM">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">TDLM</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/TDLM.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-news" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">News</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-news">
<li><h6 class="dropdown-header" data-toc-skip>Releases</h6></li>
    <li><a class="external-link dropdown-item" href="https://github.com/EpiVec/TDLM/releases/tag/v1.0.0">Version 1.0.0</a></li>
    <li><a class="external-link dropdown-item" href="https://github.com/EpiVec/TDLM/releases/tag/v0.1.0">Version 0.1.0</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../news/index.html">Changelog</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/EpiVec/TDLM/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Tutorial for TDLM</h1>
                        <h4 data-toc-skip class="author">Maxime
Lenormand</h4>
            
            <h4 data-toc-skip class="date">2024-12-20</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/EpiVec/TDLM/blob/master/vignettes/TDLM.Rmd" class="external-link"><code>vignettes/TDLM.Rmd</code></a></small>
      <div class="d-none name"><code>TDLM.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This tutorial aims to describe the different features of the R
package <code>TDLM</code>. The main purpose of the <code>TDLM</code>
package is to provide a rigorous framework for fairly comparing trip
distribution laws and models <span class="citation">(Lenormand <em>et
al.</em>, 2016)</span>. This general framework is based on a two-step
approach for generating mobility flows by separating the trip
distribution law, such as gravity or intervening opportunities, from the
modeling approach used to generate flows from this law.</p>
</div>
<div class="section level2">
<h2 id="a-short-note-on-terminology">A short note on terminology<a class="anchor" aria-label="anchor" href="#a-short-note-on-terminology"></a>
</h2>
<p>This framework is part of the four-step travel model. It corresponds
to the second step, called trip distribution, which aims to match trip
origins with trip destinations. The model used to generate trips or
flows, and more generally the degree of interaction between locations,
is often referred to as a spatial interaction model. Depending on the
research area, a matrix or a network formalism may be used to describe
these spatial interactions. Origin-Destination matrices (or trip tables)
are common in geography or transportation, while in statistical physics
or complex systems studies, the term mobility networks is usually
preferred.</p>
</div>
<div class="section level2">
<h2 id="origindestination-matrix">Origin–Destination matrix<a class="anchor" aria-label="anchor" href="#origindestination-matrix"></a>
</h2>
<p>The description of movements within a given area is represented by an
Origin-Destination (OD) matrix. The area of interest is divided into
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>n</mi><annotation encoding="application/x-tex">n</annotation></semantics></math>
locations, and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>T</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><annotation encoding="application/x-tex">T_{ij}</annotation></semantics></math>
represents the volume of flows between location
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
and location
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math>.
This volume typically corresponds to the number of trips or a commuting
flow (i.e., the number of individuals living in
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
and working in
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math>).
The OD matrix is square, contains only positive values, and may have a
zero diagonal (Figure 1).</p>
<br><center>
<img align="bottom" width="60%" height="60%" src="../reference/figures/OD.png" alt="OD matrix">
</center>
<br><center>
<b>Figure 1: Schematic representation of an Origin-Destination
matrix.</b>
</center>
<p><br></p>
</div>
<div class="section level2">
<h2 id="aggregated-inputs-information">Aggregated inputs information<a class="anchor" aria-label="anchor" href="#aggregated-inputs-information"></a>
</h2>
<p>Three categories of inputs are typically considered to simulate an OD
matrix (Figure 2). The masses and distances are the primary ingredients
used to generate a matrix of probabilities based on a given distribution
law. Thus, the probability
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><annotation encoding="application/x-tex">p_{ij}</annotation></semantics></math>
of observing a trip from location
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
to location
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math>
depends on the masses, the demand at the origin
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>m</mi><mi>i</mi></msub><annotation encoding="application/x-tex">m_i</annotation></semantics></math>),
and the offer at the destination
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>m</mi><mi>j</mi></msub><annotation encoding="application/x-tex">m_j</annotation></semantics></math>).
Typically, population is used as a surrogate for demand and offer. The
probability of movement also depends on the costs, which are based on
the distance
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>d</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><annotation encoding="application/x-tex">d_{ij}</annotation></semantics></math>
between locations or the number of opportunities
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>s</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><annotation encoding="application/x-tex">s_{ij}</annotation></semantics></math>
between locations, depending on the chosen law (more details are
provided in the next “Trip distribution laws” section). In general, the
effect of the cost can be adjusted with a parameter.</p>
<p>The margins are used to generate an OD matrix from the matrix of
probabilities while preserving the total number of trips
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>N</mi><annotation encoding="application/x-tex">N</annotation></semantics></math>),
the number of outgoing trips
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>O</mi><mi>i</mi></msub><annotation encoding="application/x-tex">O_i</annotation></semantics></math>),
and/or the number of incoming trips
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>D</mi><mi>j</mi></msub><annotation encoding="application/x-tex">D_j</annotation></semantics></math>)
(more details are provided in the “Constrained distribution models”
section).</p>
<br><center>
<img align="bottom" width="75%" height="75%" src="../reference/figures/Inputs.png" alt="Inputs information">
</center>
<br><center>
<b>Figure 2: Schematic representation of the aggregated inputs
information. </b>
</center>
<p><br></p>
</div>
<div class="section level2">
<h2 id="trip-distribution-laws">Trip distribution laws<a class="anchor" aria-label="anchor" href="#trip-distribution-laws"></a>
</h2>
<p>The purpose of a trip distribution law is to estimate the probability
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><annotation encoding="application/x-tex">p_{ij}</annotation></semantics></math>
that, out of all the possible travels in the system, there is one
between location
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
and location
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math>.
This probability is asymmetric in
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math>,
as are the flows themselves. It takes the form of a square matrix of
probabilities. This probability is normalized across all possible pairs
of origins and destinations, such that
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>,</mo><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></msubsup><msub><mi>p</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\sum_{i,j=1}^n p_{ij} = 1</annotation></semantics></math>.
Therefore, a matrix of probabilities can be obtained by normalizing any
OD matrix (Figure 3).</p>
<br><center>
<img align="bottom" width="60%" height="60%" src="../reference/figures/Proba.png" alt="Probability matrix">
</center>
<br><center>
<b>Figure 3: Schematic representation of the matrix of probabilities.
</b>
</center>
<p><br></p>
<p>As mentioned in the previous section, most trip distribution laws
depend on the demand at the origin
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>m</mi><mi>i</mi></msub><annotation encoding="application/x-tex">m_i</annotation></semantics></math>),
the offer at the destination
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>m</mi><mi>j</mi></msub><annotation encoding="application/x-tex">m_j</annotation></semantics></math>),
and a cost to move from
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math>.
There are two major approaches for estimating the probability matrix.
The traditional gravity approach, in analogy with Newton’s law of
gravitation, is based on the assumption that the amount of trips between
two locations is related to their populations and decays according to a
function of the distance
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>d</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><annotation encoding="application/x-tex">d_{ij}</annotation></semantics></math>
between locations. In contrast to the gravity law, the laws of
intervening opportunities hinge on the assumption that the number of
opportunities
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>s</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><annotation encoding="application/x-tex">s_{ij}</annotation></semantics></math>
between locations plays a more important role than the distance <span class="citation">(Lenormand <em>et al.</em>, 2016)</span>. This
fundamental difference between the two schools of thought is illustrated
in Figure 4.</p>
<br><center>
<img align="bottom" width="50%" height="50%" src="../reference/figures/GravVsOpp.png" alt="Gravity vs IO">
</center>
<br><center>
<b>Figure 4: Illustration of the fundamental difference between gravity
and intervening opportunity laws. </b>
</center>
<p><br></p>
<p>It is important to note that the effect of the cost between locations
(distance or number of opportunities) can usually be adjusted with a
parameter, which can be calibrated automatically or by comparing the
simulated matrix with observed data.</p>
</div>
<div class="section level2">
<h2 id="constrained-distribution-models">Constrained distribution models<a class="anchor" aria-label="anchor" href="#constrained-distribution-models"></a>
</h2>
<p>The purpose of the trip distribution models is to generate an OD
matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><mi>T</mi><mo accent="true">̃</mo></mover><mo>=</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mover><mi>T</mi><mo accent="true">̃</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\tilde{T}=(\tilde{T}_{ij})</annotation></semantics></math>
by drawing at random
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>N</mi><annotation encoding="application/x-tex">N</annotation></semantics></math>
trips from the trip distribution law
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>p</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mn>1</mn><mo>≤</mo><mi>i</mi><mo>,</mo><mi>j</mi><mo>≤</mo><mi>n</mi></mrow></msub><annotation encoding="application/x-tex">(p_{ij})_{1 \leq i,j \leq n}</annotation></semantics></math>
respecting different level of constraints according to the model. We
considered four different types of models in this package. As can be
observed in Figure 5, the four models respect different level of
constraints from the total number of trips to the total number of
out-going and in-coming trips by locations (i.e. the margins).</p>
<br><center>
<img align="bottom" width="80%" height="80%" src="../reference/figures/Models.png" alt="Constrained models">
</center>
<br><center>
<b>Figure 5: Schematic representation of the constrained distribution
models. </b>
</center>
<p><br></p>
<p>More specifically, the volume of flows
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mover><mi>T</mi><mo accent="true">̃</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub><annotation encoding="application/x-tex">\tilde{T}_{ij}</annotation></semantics></math>
is generated from the matrix of probability with multinomial random
draws that will take different forms according to the model used <span class="citation">(Lenormand <em>et al.</em>, 2016)</span>. Therefore,
since the process is stochastic, each simulated matrix is unique and
composed of integers. Note that it is also possible to generate an
average matrix from the multinomial trials.</p>
</div>
<div class="section level2">
<h2 id="goodness-of-fit-measures">Goodness-of-fit measures<a class="anchor" aria-label="anchor" href="#goodness-of-fit-measures"></a>
</h2>
<p>Finally, the trip distribution laws can be calibrated, and both the
trip distribution laws and models can be evaluated by comparing a
simulated matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>T</mi><mo accent="true">̃</mo></mover><annotation encoding="application/x-tex">\tilde{T}</annotation></semantics></math>
with the observed matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>T</mi><annotation encoding="application/x-tex">T</annotation></semantics></math>.
These comparisons rely on various goodness-of-fit measures, which may or
may not account for the distance between locations. These measures are
described above.</p>
<div class="section level3">
<h3 id="common-part-of-commuters-cpc">Common Part of Commuters (CPC)<a class="anchor" aria-label="anchor" href="#common-part-of-commuters-cpc"></a>
</h3>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><mi>P</mi><mi>C</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>T</mi><mo>,</mo><mover><mi>T</mi><mo accent="true">̃</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mfrac><mrow><mn>2</mn><mo>⋅</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>,</mo><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mi>m</mi><mi>i</mi><mi>n</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>T</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>,</mo><msub><mover><mi>T</mi><mo accent="true">̃</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><mi>N</mi><mo>+</mo><mover><mi>N</mi><mo accent="true">̃</mo></mover></mrow></mfrac></mrow><annotation encoding="application/x-tex">\displaystyle CPC(T,\tilde{T}) = \frac{2\cdot\sum_{i,j=1}^n min(T_{ij},\tilde{T}_{ij})}{N + \tilde{N}}</annotation></semantics></math></p>
<p><span class="citation">(Gargiulo <em>et al.</em>, 2012; Lenormand
<em>et al.</em>, 2012, 2016)</span></p>
</div>
<div class="section level3">
<h3 id="normalized-root-mean-square-error-nrmse">Normalized Root Mean Square Error (NRMSE)<a class="anchor" aria-label="anchor" href="#normalized-root-mean-square-error-nrmse"></a>
</h3>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mi>R</mi><mi>M</mi><mi>S</mi><mi>E</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>T</mi><mo>,</mo><mover><mi>T</mi><mo accent="true">̃</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msqrt><mfrac><mrow><munderover><mo>∑</mo><mrow><mi>i</mi><mo>,</mo><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><msup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>T</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>−</mo><msub><mover><mi>T</mi><mo accent="true">̃</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mn>2</mn></msup></mrow><mi>N</mi></mfrac></msqrt></mrow><annotation encoding="application/x-tex">\displaystyle NRMSE(T,\tilde{T}) = \sqrt{\frac{\sum_{i,j=1}^n (T_{ij}-\tilde{T}_{ij})^2}{N}}</annotation></semantics></math></p>
</div>
<div class="section level3">
<h3 id="kullbackleibler-divergence-ks">Kullback–Leibler divergence (KS)<a class="anchor" aria-label="anchor" href="#kullbackleibler-divergence-ks"></a>
</h3>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi><mi>L</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>T</mi><mo>,</mo><mover><mi>T</mi><mo accent="true">̃</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>,</mo><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mfrac><msub><mi>T</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mi>N</mi></mfrac><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><mfrac><msub><mi>T</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mi>N</mi></mfrac><mfrac><mover><mi>N</mi><mo accent="true">̃</mo></mover><msub><mover><mi>T</mi><mo accent="true">̃</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub></mfrac><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\displaystyle KL(T,\tilde{T}) = \sum_{i,j=1}^n \frac{T_{ij}}{N}\log\left(\frac{T_{ij}}{N}\frac{\tilde{N}}{\tilde{T}_{ij}}\right)</annotation></semantics></math><span class="citation">(Kullback &amp; Leibler, 1951)</span></p>
</div>
<div class="section level3">
<h3 id="common-part-of-links-cpl">Common Part of Links (CPL)<a class="anchor" aria-label="anchor" href="#common-part-of-links-cpl"></a>
</h3>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><mi>P</mi><mi>L</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>T</mi><mo>,</mo><mover><mi>T</mi><mo accent="true">̃</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mfrac><mrow><mn>2</mn><mo>⋅</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>,</mo><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><msub><mn>1</mn><mrow><msub><mi>T</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>&gt;</mo><mn>0</mn></mrow></msub><mo>⋅</mo><msub><mn>1</mn><mrow><msub><mover><mi>T</mi><mo accent="true">̃</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>&gt;</mo><mn>0</mn></mrow></msub></mrow><mrow><munderover><mo>∑</mo><mrow><mi>i</mi><mo>,</mo><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><msub><mn>1</mn><mrow><msub><mi>T</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>&gt;</mo><mn>0</mn></mrow></msub><mo>+</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>,</mo><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><msub><mn>1</mn><mrow><msub><mover><mi>T</mi><mo accent="true">̃</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>&gt;</mo><mn>0</mn></mrow></msub></mrow></mfrac></mrow><annotation encoding="application/x-tex">\displaystyle CPL(T,\tilde{T}) = \frac{2\cdot\sum_{i,j=1}^n 1_{T_{ij}&gt;0} \cdot 1_{\tilde{T}_{ij}&gt;0}}{\sum_{i,j=1}^n 1_{T_{ij}&gt;0} + \sum_{i,j=1}^n 1_{\tilde{T}_{ij}&gt;0}}</annotation></semantics></math><span class="citation">(Lenormand <em>et al.</em>, 2016)</span></p>
</div>
<div class="section level3">
<h3 id="common-part-of-commuters-based-on-the-disance-cpc_d">Common Part of Commuters based on the disance (CPC_d)<a class="anchor" aria-label="anchor" href="#common-part-of-commuters-based-on-the-disance-cpc_d"></a>
</h3>
<p>Let us consider
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>N</mi><mi>k</mi></msub><annotation encoding="application/x-tex">N_k</annotation></semantics></math>
(and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mover><mi>N</mi><mo accent="true">̃</mo></mover><mi>k</mi></msub><annotation encoding="application/x-tex">\tilde{N}_k</annotation></semantics></math>)
the sum of observed (and simulated) flows at a distance comprised in the
bin
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false" form="prefix">[</mo><mtext mathvariant="normal">bin_size</mtext><mo>⋅</mo><mi>k</mi><mo>−</mo><mtext mathvariant="normal">bin_size</mtext><mo>,</mo><mtext mathvariant="normal">bin_size</mtext><mo>⋅</mo><mi>k</mi><mo stretchy="false" form="prefix">[</mo></mrow><annotation encoding="application/x-tex">[\mbox{bin_size} \cdot k-\mbox{bin_size}, \mbox{bin_size} \cdot k[</annotation></semantics></math>.</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><mi>P</mi><msub><mi>C</mi><mi>d</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>T</mi><mo>,</mo><mover><mi>T</mi><mo accent="true">̃</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mfrac><mrow><mn>2</mn><mo>⋅</mo><munderover><mo>∑</mo><mrow><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mo accent="false">∞</mo></munderover><mi>m</mi><mi>i</mi><mi>n</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>N</mi><mi>k</mi></msub><mo>,</mo><msub><mover><mi>N</mi><mo accent="true">̃</mo></mover><mi>k</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><mi>N</mi><mo>+</mo><mover><mi>N</mi><mo accent="true">̃</mo></mover></mrow></mfrac></mrow><annotation encoding="application/x-tex">\displaystyle CPC_d(T,\tilde{T}) = \frac{2\cdot\sum_{k=1}^{\infty} min(N_{k},\tilde{N}_{k})}{N+\tilde{N}}</annotation></semantics></math></p>
<p><span class="citation">(Lenormand <em>et al.</em>, 2016)</span></p>
</div>
<div class="section level3">
<h3 id="kolmogorv-smirnov-statistic-and-p-value-ks-">Kolmogorv-Smirnov statistic and p-value (KS).<a class="anchor" aria-label="anchor" href="#kolmogorv-smirnov-statistic-and-p-value-ks-"></a>
</h3>
<p>These measures, described in <span class="citation">Massey
(1951)</span>, are based on the observed and simulated flow distance
distributions and are computed using the <a href="https://hectorrdb.github.io/Ecume/reference/ks_test.html" class="external-link">ks_test</a>
function from the <a href="https://cran.r-project.org/package=Ecume" class="external-link">Ecume</a> package.</p>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="example-of-commuting-in-kansas">Example of commuting in Kansas<a class="anchor" aria-label="anchor" href="#example-of-commuting-in-kansas"></a>
</h2>
<div class="section level3">
<h3 id="data">Data<a class="anchor" aria-label="anchor" href="#data"></a>
</h3>
<p>In this example, we will use commuting data from US Kansas in 2000 to
illustrate<br>
the main functions of the package. The dataset comprises three tables
providing information on commuting flows between the 105 US Kansas
counties in 2000. The observed OD matrix <a href="https://epivec.github.io/TDLM/reference/od.html">od</a> is a
zero-diagonal square matrix of integers. Each element of the matrix
represents the number of commuters between a pair of US Kansas
counties.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">od</span><span class="op">)</span></span>
<span></span>
<span><span class="va">od</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##       20001 20003 20005 20007 20009</span></span>
<span><span class="co">## 20001     0    71     0     0     0</span></span>
<span><span class="co">## 20003   236     0     0     0     0</span></span>
<span><span class="co">## 20005     0     0     0     0     0</span></span>
<span><span class="co">## 20007     0     0     0     0     8</span></span>
<span><span class="co">## 20009     0     0     0    11     0</span></span></code></pre>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">od</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 105 105</span></span></code></pre>
<p>The aggregated data are composed of the <a href="https://epivec.github.io/TDLM/reference/distance.html">distance</a>
matrix,</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">distance</span><span class="op">)</span></span>
<span></span>
<span><span class="va">distance</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##           20001     20003    20005    20007    20009</span></span>
<span><span class="co">## 20001   0.00000  36.50943 182.9291 306.8503 308.8995</span></span>
<span><span class="co">## 20003  36.50943   0.00000 146.4335 317.5593 303.2348</span></span>
<span><span class="co">## 20005 182.92913 146.43350   0.0000 389.5330 319.5319</span></span>
<span><span class="co">## 20007 306.85034 317.55926 389.5330   0.0000 139.0661</span></span>
<span><span class="co">## 20009 308.89947 303.23478 319.5319 139.0661   0.0000</span></span></code></pre>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">distance</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 105 105</span></span></code></pre>
<p>and the masses and margins contained in the data.frame <a href="https://epivec.github.io/TDLM/reference/mass.html">mass</a>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">mass</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mass</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,<span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##       Population Out-commuters In-commuters</span></span>
<span><span class="co">## 20001      14385          1267         1343</span></span>
<span><span class="co">## 20003       8110          1346          361</span></span>
<span><span class="co">## 20005      16774          1065         1247</span></span>
<span><span class="co">## 20007       5307           260          201</span></span>
<span><span class="co">## 20009      28205          1129         1324</span></span>
<span><span class="co">## 20011      15379           662          761</span></span>
<span><span class="co">## 20013      10724          1148          984</span></span>
<span><span class="co">## 20015      59482         14182         3579</span></span>
<span><span class="co">## 20017       3030           681           93</span></span>
<span><span class="co">## 20019       4359           486          180</span></span></code></pre>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">mass</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 105   3</span></span></code></pre>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">mass</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mi</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">mass</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mj</span> <span class="op">&lt;-</span> <span class="va">mi</span></span>
<span></span>
<span><span class="va">Oi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">mass</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">Oi</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">mass</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Dj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">mass</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">Dj</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">mass</span><span class="op">)</span></span></code></pre></div>
<p>The data must always be based on the same number of locations sorted
in the same<br>
order. The function <a href="https://epivec.github.io/TDLM/reference/check_format_names.html">check_format_names</a>
can be used to verify the validity of all inputs before running the main
functions of the package.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/check_format_names.html">check_format_names</a></span><span class="op">(</span>vectors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>mi <span class="op">=</span> <span class="va">mi</span>, mj <span class="op">=</span> <span class="va">mj</span>, Oi <span class="op">=</span> <span class="va">Oi</span>, Dj <span class="op">=</span> <span class="va">Dj</span><span class="op">)</span>,</span>
<span>                   matrices <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>od <span class="op">=</span> <span class="va">od</span>, distance <span class="op">=</span> <span class="va">distance</span><span class="op">)</span>,</span>
<span>                   check <span class="op">=</span> <span class="st">"format_and_names"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## The inputs passed the format_and_names checks successfully!</span></span></code></pre>
<p>Optional spatial information are also provided here. <a href="https://epivec.github.io/TDLM/reference/county.html">county</a> is
a spatial object containing the geometry of the 105 US Kansas counties
in 2000.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">county</span><span class="op">)</span></span>
<span></span>
<span><span class="va">county</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,<span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## Simple feature collection with 10 features and 4 fields</span></span>
<span><span class="co">## Geometry type: MULTIPOLYGON</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: -99.0334 ymin: 36.99796 xmax: -94.6139 ymax: 40.0006</span></span>
<span><span class="co">## Geodetic CRS:  WGS 84</span></span>
<span><span class="co">##         ID Longitude Latitude     Area                       geometry</span></span>
<span><span class="co">## 1016 20001 -95.30137 37.88581 1307.667 MULTIPOLYGON (((-95.08805 3...</span></span>
<span><span class="co">## 983  20003 -95.29334 38.21429 1512.337 MULTIPOLYGON (((-95.07771 3...</span></span>
<span><span class="co">## 869  20005 -95.31288 39.53194 1125.682 MULTIPOLYGON (((-95.56751 3...</span></span>
<span><span class="co">## 1064 20007 -98.68482 37.22888 2941.524 MULTIPOLYGON (((-98.52686 3...</span></span>
<span><span class="co">## 962  20009 -98.75650 38.47904 2330.541 MULTIPOLYGON (((-99.03239 3...</span></span>
<span><span class="co">## 1017 20011 -94.84928 37.85522 1653.609 MULTIPOLYGON (((-94.61413 3...</span></span>
<span><span class="co">## 843  20013 -95.56416 39.82657 1480.469 MULTIPOLYGON (((-95.77332 3...</span></span>
<span><span class="co">## 1011 20015 -96.83911 37.78125 3744.168 MULTIPOLYGON (((-96.52571 3...</span></span>
<span><span class="co">## 974  20017 -96.59395 38.30205 2013.697 MULTIPOLYGON (((-96.81972 3...</span></span>
<span><span class="co">## 1079 20019 -96.24535 37.15007 1669.418 MULTIPOLYGON (((-96.52495 3...</span></span></code></pre>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">county</span><span class="op">)</span></span></code></pre></div>
<p><img src="TDLM_files/figure-html/unnamed-chunk-5-1.png" width="768"></p>
<p><a href="https://epivec.github.io/TDLM/reference/coords.html">coords</a>
and <a href="https://epivec.github.io/TDLM/reference/coords_xy.html">coords_xy</a>
are two dataframes providing longitude/latitude and X/Y coordinates for
each location, respectively.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">coords</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,<span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##       Longitude Latitude</span></span>
<span><span class="co">## 20001 -95.30137 37.88581</span></span>
<span><span class="co">## 20003 -95.29334 38.21429</span></span>
<span><span class="co">## 20005 -95.31288 39.53194</span></span>
<span><span class="co">## 20007 -98.68482 37.22888</span></span>
<span><span class="co">## 20009 -98.75650 38.47904</span></span>
<span><span class="co">## 20011 -94.84928 37.85522</span></span>
<span><span class="co">## 20013 -95.56416 39.82657</span></span>
<span><span class="co">## 20015 -96.83911 37.78125</span></span>
<span><span class="co">## 20017 -96.59395 38.30205</span></span>
<span><span class="co">## 20019 -96.24535 37.15007</span></span></code></pre>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">coords_xy</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,<span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##               X       Y</span></span>
<span><span class="co">## 20001 -10608899 4563329</span></span>
<span><span class="co">## 20003 -10608005 4609773</span></span>
<span><span class="co">## 20005 -10610183 4798171</span></span>
<span><span class="co">## 20007 -10985547 4471108</span></span>
<span><span class="co">## 20009 -10993524 4647367</span></span>
<span><span class="co">## 20011 -10558574 4559025</span></span>
<span><span class="co">## 20013 -10638154 4840804</span></span>
<span><span class="co">## 20015 -10780080 4548659</span></span>
<span><span class="co">## 20017 -10752789 4622229</span></span>
<span><span class="co">## 20019 -10713984 4460066</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="extract-additional-spatial-information">Extract Additional Spatial Information<a class="anchor" aria-label="anchor" href="#extract-additional-spatial-information"></a>
</h3>
<p>The functions <a href="https://epivec.github.io/TDLM/reference/extract_distances.html">extract_distances</a>,
<a href="https://epivec.github.io/TDLM/reference/check_format_names.html">extract_opportunities</a>,
and <a href="https://epivec.github.io/TDLM/reference/extract_spatial_information.html">extract_spatial_information</a><br>
can be used to extract matrices of distances and the number of
intervening opportunities.</p>
<p>The first function computes distances in kilometers between pairs of
locations based on geographical coordinates. It can calculate either
great-circle distances, using longitude/latitude coordinates and the
Haversine formula</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">haversine_d</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_distances.html">extract_distances</a></span><span class="op">(</span>coords <span class="op">=</span> <span class="va">coords</span>,</span>
<span>                                 method <span class="op">=</span> <span class="st">"Haversine"</span><span class="op">)</span></span>
<span><span class="va">haversine_d</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##           [,1]      [,2]     [,3]     [,4]     [,5]</span></span>
<span><span class="co">## [1,]   0.00000  36.50943 182.9291 306.8503 308.8995</span></span>
<span><span class="co">## [2,]  36.50943   0.00000 146.4335 317.5593 303.2348</span></span>
<span><span class="co">## [3,] 182.92913 146.43350   0.0000 389.5330 319.5319</span></span>
<span><span class="co">## [4,] 306.85034 317.55926 389.5330   0.0000 139.0661</span></span>
<span><span class="co">## [5,] 308.89947 303.23478 319.5319 139.0661   0.0000</span></span></code></pre>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">distance</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##           20001     20003    20005    20007    20009</span></span>
<span><span class="co">## 20001   0.00000  36.50943 182.9291 306.8503 308.8995</span></span>
<span><span class="co">## 20003  36.50943   0.00000 146.4335 317.5593 303.2348</span></span>
<span><span class="co">## 20005 182.92913 146.43350   0.0000 389.5330 319.5319</span></span>
<span><span class="co">## 20007 306.85034 317.55926 389.5330   0.0000 139.0661</span></span>
<span><span class="co">## 20009 308.89947 303.23478 319.5319 139.0661   0.0000</span></span></code></pre>
<p>or Euclidean distances based on X/Y coordinates</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">xy_d</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_distances.html">extract_distances</a></span><span class="op">(</span>coords <span class="op">=</span> <span class="va">coords_xy</span>,</span>
<span>                          method <span class="op">=</span> <span class="st">"Euclidean"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">oldmar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">mar</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4.5</span>, <span class="fl">6</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">haversine_d</span>, <span class="va">xy_d</span>, xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">900</span><span class="op">)</span>, ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">900</span><span class="op">)</span>,</span>
<span>     type<span class="op">=</span><span class="st">"p"</span>, pch<span class="op">=</span><span class="fl">16</span>, cex<span class="op">=</span><span class="fl">2</span>, lty<span class="op">=</span><span class="fl">1</span>, lwd<span class="op">=</span><span class="fl">3</span>, </span>
<span>     col<span class="op">=</span><span class="st">"steelblue3"</span>, axes<span class="op">=</span><span class="cn">FALSE</span>, xlab<span class="op">=</span><span class="st">""</span>, ylab<span class="op">=</span><span class="st">""</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span><span class="fl">1</span>, cex.axis<span class="op">=</span><span class="fl">1.2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span><span class="fl">2</span>, cex.axis<span class="op">=</span><span class="fl">1.2</span>, las<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/mtext.html" class="external-link">mtext</a></span><span class="op">(</span><span class="st">"Haversine (km)"</span>, <span class="fl">1</span>, line <span class="op">=</span> <span class="fl">3.25</span>, cex <span class="op">=</span> <span class="fl">1.75</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/mtext.html" class="external-link">mtext</a></span><span class="op">(</span><span class="st">"Euclidean (km)"</span>, <span class="fl">2</span>, line <span class="op">=</span> <span class="fl">4</span>, cex <span class="op">=</span> <span class="fl">1.75</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/box.html" class="external-link">box</a></span><span class="op">(</span>lwd<span class="op">=</span><span class="fl">1.5</span><span class="op">)</span></span></code></pre></div>
<p><img src="TDLM_files/figure-html/unnamed-chunk-8-1.png" width="768"></p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="va">oldmar</span><span class="op">)</span></span></code></pre></div>
<p>The second function computes the number of opportunities between
pairs of locations. For a given pair of locations, the number of
opportunities between the origin and the destination is based on the
number of opportunities within a circle of radius equal to the distance
between the origin and the destination, centered at the origin. The
number of opportunities at the origin and the destination are not
included. In our case, the number of inhabitants
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>m</mi><mi>i</mi></msub><annotation encoding="application/x-tex">m_i</annotation></semantics></math>)
is used as a proxy for the number of opportunities.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sij</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_opportunities.html">extract_opportunities</a></span><span class="op">(</span>opportunity <span class="op">=</span> <span class="va">mi</span>,</span>
<span>                             distance <span class="op">=</span> <span class="va">distance</span>,</span>
<span>                             check_names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Error in get(paste0(generic, ".", class), envir = get_method_env()) : </span></span>
<span><span class="co">##   object 'type_sum.accel' not found</span></span></code></pre>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sij</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##         20001   20003   20005   20007   20009</span></span>
<span><span class="co">## 20001       0   16997 1445725 2358187 2363494</span></span>
<span><span class="co">## 20003       0       0 1374401 2403828 2354815</span></span>
<span><span class="co">## 20005 1311224 1240896       0 2454129 2346302</span></span>
<span><span class="co">## 20007 1433163 1481954 2489482       0  634786</span></span>
<span><span class="co">## 20009 1778443 1651945 1820549  344665       0</span></span></code></pre>
<p>The last function takes as input a spatial object containing the
geometry of the locations that can be handled by the <a href="https://cran.r-project.org/package=sf" class="external-link">sf</a> package. It returns
a matrix of great-circle distances between locations (expressed in km).
An optional <code>id</code><br>
can also be provided to be used as names for the outputs.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spi</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_spatial_information.html">extract_spatial_information</a></span><span class="op">(</span><span class="va">county</span>, id <span class="op">=</span> <span class="st">"ID"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sp_d</span> <span class="op">&lt;-</span> <span class="va">spi</span><span class="op">$</span><span class="va">distance</span></span>
<span></span>
<span><span class="va">sp_d</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##           20001     20003    20005    20007    20009</span></span>
<span><span class="co">## 20001   0.00000  36.50943 182.9291 306.8503 308.8995</span></span>
<span><span class="co">## 20003  36.50943   0.00000 146.4335 317.5593 303.2348</span></span>
<span><span class="co">## 20005 182.92913 146.43350   0.0000 389.5330 319.5319</span></span>
<span><span class="co">## 20007 306.85034 317.55926 389.5330   0.0000 139.0661</span></span>
<span><span class="co">## 20009 308.89947 303.23478 319.5319 139.0661   0.0000</span></span></code></pre>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">distance</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##           20001     20003    20005    20007    20009</span></span>
<span><span class="co">## 20001   0.00000  36.50943 182.9291 306.8503 308.8995</span></span>
<span><span class="co">## 20003  36.50943   0.00000 146.4335 317.5593 303.2348</span></span>
<span><span class="co">## 20005 182.92913 146.43350   0.0000 389.5330 319.5319</span></span>
<span><span class="co">## 20007 306.85034 317.55926 389.5330   0.0000 139.0661</span></span>
<span><span class="co">## 20009 308.89947 303.23478 319.5319 139.0661   0.0000</span></span></code></pre>
<p>This function also allows extracting the surface area of each
location (in square kilometers), which can be useful to calibrate the
trip distribution<br>
laws’ parameter value (see below).</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">spi</span><span class="op">$</span><span class="va">surface</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 2028.05</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="run-functions">Run functions<a class="anchor" aria-label="anchor" href="#run-functions"></a>
</h3>
<p>The main function of the package is <a href="https://epivec.github.io/TDLM/reference/run_law_model.html">run_law_model</a>.
The function has two sets of arguments, one for the law and another one
for the model. The inputs (described above) necessary to run this
function depends on the law (either the matrix of distances or number of
opportunities can be used, or neither of them for the uniform law) and
on the model and its associated constraints (number of trips, out-going
trips and/or in-coming trips). The example below will generate three
simulated ODs with the normalized gravity law with an exponential
distance decay function <span class="citation">(Lenormand <em>et
al.</em>, 2016)</span> and the Doubly Constrained Model.</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_law_model.html">run_law_model</a></span><span class="op">(</span>law <span class="op">=</span> <span class="st">"NGravExp"</span>, </span>
<span>                     mass_origin <span class="op">=</span> <span class="va">mi</span>, </span>
<span>                     mass_destination <span class="op">=</span> <span class="va">mj</span>, </span>
<span>                     distance <span class="op">=</span> <span class="va">distance</span>, </span>
<span>                     opportunity <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                     param <span class="op">=</span> <span class="fl">0.01</span>,</span>
<span>                     write_proba <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                     </span>
<span>                     model <span class="op">=</span> <span class="st">"DCM"</span>, </span>
<span>                     nb_trips <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>                     out_trips <span class="op">=</span> <span class="va">Oi</span>, </span>
<span>                     in_trips <span class="op">=</span> <span class="va">Dj</span>,</span>
<span>                     average <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>                     nbrep <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p>The output is an object of class <code>TDLM</code>. In this case it
is a list of matrices composed of the three simulated matrices
(<code>replication_1</code>, <code>replication_2</code> and
<code>replication_3</code>), the matrix of probabilities (called
<code>proba</code>) associated with the law and returned only if
<code>write_proba = TRUE</code>. The objects of class <code>TDLM</code>
contain a table <code>info</code> summarizing the simulation run.</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##        Argument    Value</span></span>
<span><span class="co">## 1           Law NGravExp</span></span>
<span><span class="co">## 2         Model      DCM</span></span>
<span><span class="co">## 3 #Replications        3</span></span>
<span><span class="co">## 4   #Parameters        1</span></span>
<span><span class="co">## 5     Parameter     0.01</span></span></code></pre>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## List of 5</span></span>
<span><span class="co">##  $ info         :'data.frame':   5 obs. of  2 variables:</span></span>
<span><span class="co">##   ..$ Argument: chr [1:5] "Law" "Model" "#Replications" "#Parameters" ...</span></span>
<span><span class="co">##   ..$ Value   : chr [1:5] "NGravExp" "DCM" "3" "1" ...</span></span>
<span><span class="co">##  $ replication_1: num [1:105, 1:105] 0 24 4 0 2 15 4 105 5 7 ...</span></span>
<span><span class="co">##   ..- attr(*, "dimnames")=List of 2</span></span>
<span><span class="co">##  $ replication_2: num [1:105, 1:105] 0 23 4 0 2 16 4 104 7 6 ...</span></span>
<span><span class="co">##   ..- attr(*, "dimnames")=List of 2</span></span>
<span><span class="co">##  $ replication_3: num [1:105, 1:105] 0 24 4 0 2 16 5 103 5 6 ...</span></span>
<span><span class="co">##   ..- attr(*, "dimnames")=List of 2</span></span>
<span><span class="co">##  $ proba        : num [1:105, 1:105] 0.00 4.31e-05 2.16e-05 3.90e-06 1.81e-05 ...</span></span>
<span><span class="co">##   ..- attr(*, "dimnames")=List of 2</span></span>
<span><span class="co">##  - attr(*, "class")= chr [1:2] "TDLM" "list"</span></span>
<span><span class="co">##  - attr(*, "from")= chr "run_law_model"</span></span>
<span><span class="co">##  - attr(*, "proba")= logi TRUE</span></span></code></pre>
<p>This simulation run was based on one parameter value. It is possible
to use a vector instead of a scalar for the <code>param</code>
argument.</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_law_model.html">run_law_model</a></span><span class="op">(</span>law <span class="op">=</span> <span class="st">"NGravExp"</span>, </span>
<span>                     mass_origin <span class="op">=</span> <span class="va">mi</span>, </span>
<span>                     mass_destination <span class="op">=</span> <span class="va">mj</span>, </span>
<span>                     distance <span class="op">=</span> <span class="va">distance</span>, </span>
<span>                     opportunity <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                     param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.01</span>,<span class="fl">0.02</span><span class="op">)</span>,</span>
<span>                     write_proba <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                     </span>
<span>                     model <span class="op">=</span> <span class="st">"DCM"</span>, </span>
<span>                     nb_trips <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>                     out_trips <span class="op">=</span> <span class="va">Oi</span>, </span>
<span>                     in_trips <span class="op">=</span> <span class="va">Dj</span>,</span>
<span>                     average <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>                     nbrep <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p>In this case a list of list of matrices will be returned (one for
each parameter value).</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##        Argument    Value</span></span>
<span><span class="co">## 1           Law NGravExp</span></span>
<span><span class="co">## 2         Model      DCM</span></span>
<span><span class="co">## 3 #Replications        3</span></span>
<span><span class="co">## 4   #Parameters        2</span></span>
<span><span class="co">## 5   Parameter 1     0.01</span></span>
<span><span class="co">## 6   Parameter 2     0.02</span></span></code></pre>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## List of 3</span></span>
<span><span class="co">##  $ info       :'data.frame': 6 obs. of  2 variables:</span></span>
<span><span class="co">##   ..$ Argument: chr [1:6] "Law" "Model" "#Replications" "#Parameters" ...</span></span>
<span><span class="co">##   ..$ Value   : chr [1:6] "NGravExp" "DCM" "3" "2" ...</span></span>
<span><span class="co">##  $ parameter_1:List of 4</span></span>
<span><span class="co">##   ..$ replication_1: num [1:105, 1:105] 0 24 4 0 2 17 4 105 5 6 ...</span></span>
<span><span class="co">##   .. ..- attr(*, "dimnames")=List of 2</span></span>
<span><span class="co">##   ..$ replication_2: num [1:105, 1:105] 0 24 4 0 2 16 4 104 5 6 ...</span></span>
<span><span class="co">##   .. ..- attr(*, "dimnames")=List of 2</span></span>
<span><span class="co">##   ..$ replication_3: num [1:105, 1:105] 0 24 4 0 2 15 4 102 5 6 ...</span></span>
<span><span class="co">##   .. ..- attr(*, "dimnames")=List of 2</span></span>
<span><span class="co">##   ..$ proba        : num [1:105, 1:105] 0.00 4.31e-05 2.16e-05 3.90e-06 1.81e-05 ...</span></span>
<span><span class="co">##   .. ..- attr(*, "dimnames")=List of 2</span></span>
<span><span class="co">##  $ parameter_2:List of 4</span></span>
<span><span class="co">##   ..$ replication_1: num [1:105, 1:105] 0 53 2 0 0 38 1 80 5 7 ...</span></span>
<span><span class="co">##   .. ..- attr(*, "dimnames")=List of 2</span></span>
<span><span class="co">##   ..$ replication_2: num [1:105, 1:105] 0 54 2 0 0 39 1 77 5 7 ...</span></span>
<span><span class="co">##   .. ..- attr(*, "dimnames")=List of 2</span></span>
<span><span class="co">##   ..$ replication_3: num [1:105, 1:105] 0 55 2 0 0 39 1 76 5 7 ...</span></span>
<span><span class="co">##   .. ..- attr(*, "dimnames")=List of 2</span></span>
<span><span class="co">##   ..$ proba        : num [1:105, 1:105] 0.00 8.13e-05 8.17e-06 7.10e-07 3.16e-06 ...</span></span>
<span><span class="co">##   .. ..- attr(*, "dimnames")=List of 2</span></span>
<span><span class="co">##  - attr(*, "class")= chr [1:2] "TDLM" "list"</span></span>
<span><span class="co">##  - attr(*, "from")= chr "run_law_model"</span></span>
<span><span class="co">##  - attr(*, "proba")= logi TRUE</span></span></code></pre>
<p>It is also important to note that the radiation law and the uniform
law are free of parameter.</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_law_model.html">run_law_model</a></span><span class="op">(</span>law <span class="op">=</span> <span class="st">"Rad"</span>, </span>
<span>                     mass_origin <span class="op">=</span> <span class="va">mi</span>, </span>
<span>                     mass_destination <span class="op">=</span> <span class="va">mj</span>, </span>
<span>                     distance <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>                     opportunity <span class="op">=</span> <span class="va">sij</span>,</span>
<span>                     param <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                     write_proba <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                     </span>
<span>                     model <span class="op">=</span> <span class="st">"DCM"</span>, </span>
<span>                     nb_trips <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>                     out_trips <span class="op">=</span> <span class="va">Oi</span>, </span>
<span>                     in_trips <span class="op">=</span> <span class="va">Dj</span>,</span>
<span>                     average <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>                     nbrep <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##        Argument Value</span></span>
<span><span class="co">## 1           Law   Rad</span></span>
<span><span class="co">## 2         Model   DCM</span></span>
<span><span class="co">## 3 #Replications     3</span></span></code></pre>
<p>The argument <code>average</code> can be used to generate an average
matrix based on a multinomial distribution (based on an infinite number
of drawings). In this case, the models’ inputs can be either positive
integer or real numbers and the output (<code>nbrep = 1</code> in this
case) will be a matrix of positive real numbers.</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span><span class="op">$</span><span class="va">replication_1</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##       [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10]</span></span>
<span><span class="co">##  [1,]    0   32    0    0    0  122    0    1    0     0</span></span>
<span><span class="co">##  [2,]  574    0    0    0    0   22    0    0    0     0</span></span>
<span><span class="co">##  [3,]    0    0    0    0    0    0  198    0    0     0</span></span>
<span><span class="co">##  [4,]    0    0    0    0    0    0    0    0    0     0</span></span>
<span><span class="co">##  [5,]    0    0    0    1    0    0    0    3    0     0</span></span>
<span><span class="co">##  [6,]   17    2    0    0    0    0    0    0    0     0</span></span>
<span><span class="co">##  [7,]    0    0  202    0    0    0    0    0    0     0</span></span>
<span><span class="co">##  [8,]    4    1    1    1   10    5    1    0    0     1</span></span>
<span><span class="co">##  [9,]    0    0    0    0    0    0    0   39    0     0</span></span>
<span><span class="co">## [10,]    0    0    0    0    0    0    0   13    0     0</span></span></code></pre>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_law_model.html">run_law_model</a></span><span class="op">(</span>law <span class="op">=</span> <span class="st">"Rad"</span>, </span>
<span>                     mass_origin <span class="op">=</span> <span class="va">mi</span>, </span>
<span>                     mass_destination <span class="op">=</span> <span class="va">mj</span>, </span>
<span>                     distance <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>                     opportunity <span class="op">=</span> <span class="va">sij</span>,</span>
<span>                     param <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                     write_proba <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                     </span>
<span>                     model <span class="op">=</span> <span class="st">"DCM"</span>, </span>
<span>                     nb_trips <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>                     out_trips <span class="op">=</span> <span class="va">Oi</span>, </span>
<span>                     in_trips <span class="op">=</span> <span class="va">Dj</span>,</span>
<span>                     average <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>                     nbrep <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##        Argument       Value</span></span>
<span><span class="co">## 1           Law         Rad</span></span>
<span><span class="co">## 2         Model         DCM</span></span>
<span><span class="co">## 3 #Replications 1 (average)</span></span></code></pre>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span><span class="op">$</span><span class="va">replication_1</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##               [,1]         [,2]         [,3]         [,4]         [,5]</span></span>
<span><span class="co">##  [1,] 4.207454e-04 3.248924e+01 1.629984e-01 0.0169209490 1.523725e-01</span></span>
<span><span class="co">##  [2,] 5.645506e+02 6.155812e-04 1.486180e-01 0.0133929974 1.262074e-01</span></span>
<span><span class="co">##  [3,] 8.174148e-02 2.927128e-02 8.564946e-04 0.0180562693 1.785403e-01</span></span>
<span><span class="co">##  [4,] 5.866220e-03 1.762770e-03 5.461852e-03 0.0006206272 1.984250e-01</span></span>
<span><span class="co">##  [5,] 7.824940e-02 2.902253e-02 2.083665e-01 1.3841229993 7.860351e-04</span></span>
<span><span class="co">##  [6,] 1.794519e+01 2.896778e+00 1.227317e-01 0.0118216041 1.064531e-01</span></span>
<span><span class="co">##  [7,] 4.854529e-02 1.825077e-02 2.003666e+02 0.0121155517 1.240133e-01</span></span>
<span><span class="co">##  [8,] 4.235287e+00 1.150834e+00 1.817298e+00 1.5952317911 1.087001e+01</span></span>
<span><span class="co">##  [9,] 1.701860e-02 6.442397e-03 1.358021e-02 0.0027705322 2.718136e-02</span></span>
<span><span class="co">## [10,] 3.657437e-01 9.929259e-03 1.029943e-02 0.0078265447 2.624542e-02</span></span>
<span><span class="co">##               [,6]         [,7]         [,8]         [,9]        [,10]</span></span>
<span><span class="co">##  [1,] 1.206594e+02 8.830093e-02  1.637304888 0.0120698542 0.0777923728</span></span>
<span><span class="co">##  [2,] 2.261365e+01 1.297312e-01  0.862290746 0.0050699294 0.0060667099</span></span>
<span><span class="co">##  [3,] 1.934135e-01 1.973623e+02  0.918724724 0.0061614808 0.0053164987</span></span>
<span><span class="co">##  [4,] 9.469349e-03 6.169547e-03  0.278155220 0.0008433002 0.0012892865</span></span>
<span><span class="co">##  [5,] 1.033249e-01 2.460352e-01  3.462295645 0.0158169340 0.0150487684</span></span>
<span><span class="co">##  [6,] 5.850044e-04 1.180099e-01  0.752499705 0.0038974570 0.0092130934</span></span>
<span><span class="co">##  [7,] 1.138611e-01 2.549294e-03  0.633540548 0.0040869895 0.0021031775</span></span>
<span><span class="co">##  [8,] 5.040588e+00 1.982879e+00  0.002650424 0.7993806174 1.0370497229</span></span>
<span><span class="co">##  [9,] 2.296625e-02 1.230871e-02 39.049317001 0.0005691793 0.0015470504</span></span>
<span><span class="co">## [10,] 6.732294e-02 1.102089e-02 13.987963900 0.0025478503 0.0002716179</span></span></code></pre>
<p>The functions <a href="https://epivec.github.io/TDLM/reference/run_law.html">run_law</a>
and <a href="https://epivec.github.io/TDLM/reference/run_model.html">run_model</a>
have been designed to run only one of the two components of the two-step
approach. They function the same as a <a href="https://epivec.github.io/TDLM/reference/run_law_model.html">run_law_model</a>,
but it is worth noting that only inter-location flows are considered for
the distribution laws, meaning that the matrix of probabilities (and
associated simulated OD matrices) generated by a given distribution law
with <a href="https://epivec.github.io/TDLM/reference/run_law_model.html">run_law_model</a>
or <a href="https://epivec.github.io/TDLM/reference/run_law.html">run_law</a>
is a zero-diagonal matrix. Nevertheless, it is possible to generate
intra-location flows with <a href="https://epivec.github.io/TDLM/reference/run_model.html">run_model</a>
taking any kind of matrix of probabilities as input.</p>
</div>
<div class="section level3">
<h3 id="parameters-calibration-models-evaluation">Parameters’ calibration &amp; models’ evaluation<a class="anchor" aria-label="anchor" href="#parameters-calibration-models-evaluation"></a>
</h3>
<p>The package contains two function to help calibrating and evaluating
the model. The function <a href="https://epivec.github.io/TDLM/reference/gof.html">gof</a> computes
goodness-of-fit measures between observed and simulated OD matrices and
the function <a href="https://epivec.github.io/TDLM/reference/calib_param.html">calib_param</a>
that estimates the optimal parameter value for a given law and a given
spatial distribution of location based on the Figure 8 in <span class="citation">(Lenormand <em>et al.</em>, 2016)</span>.</p>
<p>Let us illustrate the trip distribution laws and models’ calibration
with the the normalized gravity law with an exponential distance decay
function and the Doubly Constrained Model. Based on the average surface
area of the Kansas counties (in square kilometers) it seems that the
optimal parameter value of the normalized gravity law with an
exponential distance decay function (as described in <span class="citation">(Lenormand <em>et al.</em>, 2016)</span>) for commuting
in US Kansas counties is around 0.085.</p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="../reference/calib_param.html">calib_param</a></span><span class="op">(</span>av_surf <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">spi</span><span class="op">$</span><span class="va">surface</span><span class="op">)</span>, law <span class="op">=</span> <span class="st">"NGravExp"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.08521097</span></span></code></pre>
<p>This is just an estimation that help us to identify the potential
range of parameter value, so in order to rigorously calibrate and
evaluate the trip distribution law and model we need to compute the
goodness-of-fit measure for a wide range of parameter values.</p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_law_model.html">run_law_model</a></span><span class="op">(</span>law <span class="op">=</span> <span class="st">"NGravExp"</span>, </span>
<span>                     mass_origin <span class="op">=</span> <span class="va">mi</span>, </span>
<span>                     mass_destination <span class="op">=</span> <span class="va">mj</span>, </span>
<span>                     distance <span class="op">=</span> <span class="va">distance</span>, </span>
<span>                     opportunity <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                     param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.05</span>,<span class="fl">0.1</span>,<span class="fl">0.005</span><span class="op">)</span>,</span>
<span>                     write_proba <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                     </span>
<span>                     model <span class="op">=</span> <span class="st">"DCM"</span>, </span>
<span>                     nb_trips <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>                     out_trips <span class="op">=</span> <span class="va">Oi</span>, </span>
<span>                     in_trips <span class="op">=</span> <span class="va">Dj</span>,</span>
<span>                     average <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>                     nbrep <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="va">calib</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gof.html">gof</a></span><span class="op">(</span>sim <span class="op">=</span> <span class="va">res</span>, obs <span class="op">=</span> <span class="va">od</span>, measures <span class="op">=</span> <span class="st">"all"</span>, distance <span class="op">=</span> <span class="va">distance</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">calib</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##       Parameter Parameter_value    Simulation       CPC     NRMSE         KL</span></span>
<span><span class="co">## 1   parameter_1            0.05 replication_1 0.8162588 10.540642 0.12952476</span></span>
<span><span class="co">## 2   parameter_1            0.05 replication_2 0.8163486 10.525316 0.12964367</span></span>
<span><span class="co">## 3   parameter_1            0.05 replication_3 0.8163936 10.511522 0.12941676</span></span>
<span><span class="co">## 4   parameter_2           0.055 replication_1 0.8314424  9.433745 0.11335491</span></span>
<span><span class="co">## 5   parameter_2           0.055 replication_2 0.8313826  9.438267 0.11369198</span></span>
<span><span class="co">## 6   parameter_2           0.055 replication_3 0.8317369  9.414798 0.11324134</span></span>
<span><span class="co">## 7   parameter_3            0.06 replication_1 0.8441354  8.635911 0.09810502</span></span>
<span><span class="co">## 8   parameter_3            0.06 replication_2 0.8439757  8.641889 0.09835345</span></span>
<span><span class="co">## 9   parameter_3            0.06 replication_3 0.8439507  8.642946 0.09834198</span></span>
<span><span class="co">## 10  parameter_4           0.065 replication_1 0.8519269  8.171918 0.08810045</span></span>
<span><span class="co">## 11  parameter_4           0.065 replication_2 0.8520617  8.175737 0.08799194</span></span>
<span><span class="co">## 12  parameter_4           0.065 replication_3 0.8521515  8.164629 0.08808288</span></span>
<span><span class="co">## 13  parameter_5            0.07 replication_1 0.8551663  7.965923 0.08063600</span></span>
<span><span class="co">## 14  parameter_5            0.07 replication_2 0.8551114  7.972094 0.08060053</span></span>
<span><span class="co">## 15  parameter_5            0.07 replication_3 0.8552012  7.961028 0.08022338</span></span>
<span><span class="co">## 16  parameter_6           0.075 replication_1 0.8556604  7.960213 0.07927617</span></span>
<span><span class="co">## 17  parameter_6           0.075 replication_2 0.8557153  7.946774 0.07912821</span></span>
<span><span class="co">## 18  parameter_6           0.075 replication_3 0.8557553  7.953015 0.07913660</span></span>
<span><span class="co">## 19  parameter_7            0.08 replication_1 0.8551713  8.104668 0.07417892</span></span>
<span><span class="co">## 20  parameter_7            0.08 replication_2 0.8551613  8.111707 0.07421713</span></span>
<span><span class="co">## 21  parameter_7            0.08 replication_3 0.8551064  8.116119 0.07436102</span></span>
<span><span class="co">## 22  parameter_8           0.085 replication_1 0.8531747  8.378721 0.07382480</span></span>
<span><span class="co">## 23  parameter_8           0.085 replication_2 0.8530749  8.384562 0.07399779</span></span>
<span><span class="co">## 24  parameter_8           0.085 replication_3 0.8529801  8.381845 0.07369168</span></span>
<span><span class="co">## 25  parameter_9            0.09 replication_1 0.8498056  8.702829 0.07531783</span></span>
<span><span class="co">## 26  parameter_9            0.09 replication_2 0.8497557  8.729890 0.07633327</span></span>
<span><span class="co">## 27  parameter_9            0.09 replication_3 0.8498555  8.718953 0.07525147</span></span>
<span><span class="co">## 28 parameter_10           0.095 replication_1 0.8463616  9.095771 0.08087719</span></span>
<span><span class="co">## 29 parameter_10           0.095 replication_2 0.8464464  9.080075 0.08066436</span></span>
<span><span class="co">## 30 parameter_10           0.095 replication_3 0.8464664  9.074918 0.08089097</span></span>
<span><span class="co">## 31 parameter_11             0.1 replication_1 0.8423885  9.485180 0.08350522</span></span>
<span><span class="co">## 32 parameter_11             0.1 replication_2 0.8422886  9.489179 0.08335844</span></span>
<span><span class="co">## 33 parameter_11             0.1 replication_3 0.8422637  9.496112 0.08352203</span></span>
<span><span class="co">##          CPL     CPC_d    KS_stat   KS_pval</span></span>
<span><span class="co">## 1  0.6592593 0.8952817 0.07314636 0.9998498</span></span>
<span><span class="co">## 2  0.6597531 0.8952867 0.07307648 0.9998528</span></span>
<span><span class="co">## 3  0.6589396 0.8954015 0.07299662 0.9998566</span></span>
<span><span class="co">## 4  0.6711723 0.9155565 0.04989669 1.0000000</span></span>
<span><span class="co">## 5  0.6713432 0.9154966 0.05003645 1.0000000</span></span>
<span><span class="co">## 6  0.6704752 0.9155715 0.04992165 1.0000000</span></span>
<span><span class="co">## 7  0.6729730 0.9318333 0.03027075 1.0000000</span></span>
<span><span class="co">## 8  0.6724324 0.9317983 0.03024080 1.0000000</span></span>
<span><span class="co">## 9  0.6724324 0.9317235 0.03026076 1.0000000</span></span>
<span><span class="co">## 10 0.6724866 0.9431187 0.03378964 1.0000000</span></span>
<span><span class="co">## 11 0.6728604 0.9429839 0.03375969 1.0000000</span></span>
<span><span class="co">## 12 0.6734234 0.9432884 0.03373973 1.0000000</span></span>
<span><span class="co">## 13 0.6746356 0.9494477 0.03739339 1.0000000</span></span>
<span><span class="co">## 14 0.6746425 0.9495026 0.03740337 1.0000000</span></span>
<span><span class="co">## 15 0.6742623 0.9494677 0.03747824 1.0000000</span></span>
<span><span class="co">## 16 0.6720867 0.9480551 0.04356768 1.0000000</span></span>
<span><span class="co">## 17 0.6714845 0.9482498 0.04354272 1.0000000</span></span>
<span><span class="co">## 18 0.6722892 0.9480102 0.04352275 1.0000000</span></span>
<span><span class="co">## 19 0.6627439 0.9408077 0.04947243 1.0000000</span></span>
<span><span class="co">## 20 0.6635688 0.9408526 0.04947742 1.0000000</span></span>
<span><span class="co">## 21 0.6631579 0.9407578 0.04949739 1.0000000</span></span>
<span><span class="co">## 22 0.6516067 0.9329613 0.05646530 1.0000000</span></span>
<span><span class="co">## 23 0.6513995 0.9329463 0.05648027 1.0000000</span></span>
<span><span class="co">## 24 0.6511776 0.9329963 0.05654017 1.0000000</span></span>
<span><span class="co">## 25 0.6404421 0.9257838 0.06235508 0.9999993</span></span>
<span><span class="co">## 26 0.6408840 0.9257488 0.06236506 0.9999993</span></span>
<span><span class="co">## 27 0.6404421 0.9256989 0.06241498 0.9999993</span></span>
<span><span class="co">## 28 0.6346472 0.9187110 0.06726157 0.9999941</span></span>
<span><span class="co">## 29 0.6350679 0.9188258 0.06728652 0.9999941</span></span>
<span><span class="co">## 30 0.6350679 0.9187460 0.06729151 0.9999940</span></span>
<span><span class="co">## 31 0.6237724 0.9121923 0.07262726 0.9999620</span></span>
<span><span class="co">## 32 0.6242383 0.9121025 0.07271211 0.9999611</span></span>
<span><span class="co">## 33 0.6237724 0.9119727 0.07281194 0.9999596</span></span></code></pre>
<p>All the necessary information is stored in the object calib, most of
the goodness-of-fit measures agree on a parameter value of 0.075 in that
case with an associated average Common Part of Commuter equal to
85.6%.</p>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cpc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html" class="external-link">aggregate</a></span><span class="op">(</span><span class="va">calib</span><span class="op">$</span><span class="va">CPC</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">calib</span><span class="op">$</span><span class="va">Parameter_value</span><span class="op">)</span>, <span class="va">mean</span><span class="op">)</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span></span>
<span></span>
<span><span class="va">oldmar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">mar</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4.5</span>, <span class="fl">6</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.05</span>,<span class="fl">0.1</span>,<span class="fl">0.005</span><span class="op">)</span>, <span class="va">cpc</span>, type<span class="op">=</span><span class="st">"b"</span>, pch<span class="op">=</span><span class="fl">16</span>, cex<span class="op">=</span><span class="fl">2</span>, lty<span class="op">=</span><span class="fl">1</span>, lwd<span class="op">=</span><span class="fl">3</span>, </span>
<span>     col<span class="op">=</span><span class="st">"steelblue3"</span>, axes<span class="op">=</span><span class="cn">FALSE</span>, xlab<span class="op">=</span><span class="st">""</span>, ylab<span class="op">=</span><span class="st">""</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span><span class="fl">1</span>, cex.axis<span class="op">=</span><span class="fl">1.2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span><span class="fl">2</span>, cex.axis<span class="op">=</span><span class="fl">1.2</span>, las<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/mtext.html" class="external-link">mtext</a></span><span class="op">(</span><span class="st">"Parameter value"</span>, <span class="fl">1</span>, line <span class="op">=</span> <span class="fl">3.25</span>, cex <span class="op">=</span> <span class="fl">1.75</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/mtext.html" class="external-link">mtext</a></span><span class="op">(</span><span class="st">"Common Part of Commuters"</span>, <span class="fl">2</span>, line <span class="op">=</span> <span class="fl">4</span>, cex <span class="op">=</span> <span class="fl">1.75</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/box.html" class="external-link">box</a></span><span class="op">(</span>lwd<span class="op">=</span><span class="fl">1.5</span><span class="op">)</span></span></code></pre></div>
<p><img src="TDLM_files/figure-html/unnamed-chunk-20-1.png" width="768"></p>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="va">oldmar</span><span class="op">)</span></span></code></pre></div>
<hr>
</div>
</div>
<div class="section level2">
<h2 class="unnumbered" id="reference">Reference<a class="anchor" aria-label="anchor" href="#reference"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="1">
<div id="ref-Gargiulo2012" class="csl-entry">
Gargiulo F, Lenormand M, Huet S &amp; Baqueiro Espinosa O (2012)
Commuting network model: Getting to the essentials. <em>Journal of
Artificial Societies and Social Simulation</em> 15, 13.
</div>
<div id="ref-Kullback1951" class="csl-entry">
Kullback S &amp; Leibler RA (1951) <span class="nocase">On Information
and Sufficiency</span>. <em>The Annals of Mathematical Statistics</em>
22, 79–86.
</div>
<div id="ref-Lenormand2016" class="csl-entry">
Lenormand M, Bassolas A &amp; Ramasco JJ (2016) Systematic comparison of
trip distribution laws and models. <em>Journal of Transport
Geography</em> 51, 158–169.
</div>
<div id="ref-Lenormand2012" class="csl-entry">
Lenormand M, Huet S, Gargiulo F &amp; Deffuant G (2012) A
<span>U</span>niversal <span>M</span>odel of <span>C</span>ommuting
<span>N</span>etworks. <em>PLoS ONE</em> 7, e45985.
</div>
<div id="ref-Massey1951" class="csl-entry">
Massey FJ (1951) The <span>K</span>olmogorov-<span>S</span>mirnov test
for goodness of fit. <em>Journal of the American Statistical
Association</em> 46, 68–78.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Maxime Lenormand.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
